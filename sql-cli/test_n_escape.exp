#!/usr/bin/expect -f
set timeout 5

# Start the application
spawn ./target/release/sql-cli test_n_escape.csv -e "select * from data"

# Wait for initial display
expect {
    timeout { puts "TIMEOUT: Initial display"; exit 1 }
    "rows*cols" { }
}

# Enter search mode with /
send "/"
expect {
    timeout { puts "TIMEOUT: Entering search mode"; exit 1 }
    "Search:" { }
}

# Type search pattern
send "derivatives"
expect {
    timeout { puts "TIMEOUT: Typing search pattern"; exit 1 }
    "derivatives" { }
}

# Apply search with Enter
send "\r"
expect {
    timeout { puts "TIMEOUT: Applying search"; exit 1 }
    -re "Match.*of" { }
}

# Navigate with n a few times
send "n"
expect {
    timeout { puts "TIMEOUT: First n navigation"; exit 1 }
    -re "Match.*of" { }
}

send "n"
expect {
    timeout { puts "TIMEOUT: Second n navigation"; exit 1 }
    -re "Match.*of" { }
}

# Press Escape to clear search
send "\033"
expect {
    timeout { puts "TIMEOUT: Escape to clear search"; exit 1 }
    "Search cleared" { puts "✓ Search cleared message appeared" }
    -re ".*" { }
}

# Brief pause
sleep 0.5

# Now test N key - should toggle line numbers, not navigate
send "N"
expect {
    timeout { puts "TIMEOUT: N key after Escape"; exit 1 }
    "Toggled line numbers" { puts "✓ SUCCESS: N key toggles line numbers after Escape!" }
    -re "Match.*of" { puts "✗ FAIL: N key still navigating search!"; exit 1 }
    -re ".*" { 
        # Check F5 debug to see state
        send "\[24~"
        expect {
            timeout { puts "TIMEOUT: F5 debug"; exit 1 }
            -re "pattern='(\[^']*)'.*active=(\[^ ]*)" {
                set pattern $expect_out(1,string)
                set active $expect_out(2,string)
                if {$pattern != ""} {
                    puts "✗ FAIL: Search pattern still present: '$pattern', active=$active"
                    exit 1
                } else {
                    puts "✓ Pattern cleared, checking for line number toggle..."
                }
            }
        }
    }
}

# Exit
send "q"
expect eof
